#!/usr/bin/env php
<?php

declare(strict_types=1);

require __DIR__ . '/../vendor/autoload.php';

use Translator\Cache;
use Translator\Config;

$projectDir = $argv[1] ?? dirname(__DIR__, 2);
$config = Config::load($projectDir);
$cache = new Cache($config);

$sourceDir = $config->sourceDir();
if (!is_dir($sourceDir)) {
    fwrite(STDERR, "Source directory not found: {$sourceDir}\n");
    exit(1);
}

$count = 0;
$iterator = new RecursiveIteratorIterator(
    new RecursiveDirectoryIterator($sourceDir, FilesystemIterator::SKIP_DOTS)
);
foreach ($iterator as $file) {
    if (!$file->isFile()) {
        continue;
    }
    if (!str_ends_with($file->getFilename(), '.md')) {
        continue;
    }
    $path = $file->getPathname();
    $relativePath = ltrim(substr($path, strlen($sourceDir)), '/');
    $content = file_get_contents($path);
    if (!is_string($content)) {
        continue;
    }
    $cache->setFileSourceText($relativePath, $content);
    $cache->setFileSourceHash($relativePath, md5($content));
    $count++;
}

fwrite(STDOUT, "Backfilled source_text for {$count} file(s)\n");
exit(0);
